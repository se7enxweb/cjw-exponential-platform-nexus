{% extends nglayouts.layoutTemplate|default( site_bundle_name ~ '::pagelayout.html.twig' ) %}

{% set tracking_cookie_name = "UseTracking" %}

{# This should be defined somewhere in the yml settings, so the trackers can be
   dynamically triggered. #}
{% set tracker_list = {
    'piwik' : 'Piwik'
} %}

{% block content %}
    <!-- JAC_TRACKING_SETTINGS START -->
    <div class="container">
        <div id="tracking-settings">
            {# --- Styling part --- #}
            <style>
                #tracker-display {
                    font-weight: bold;
                }

                #tracker-display button {
                    font-weight: normal;
                    display: block;
                    margin-top: 12px;
                }

                #tracker-display > .activated,
                #tracker-display.active > .deactivated {
                    display: none;
                }
                #tracker-display > .deactivated,
                #tracker-display.active > .activated {
                    display: inline;
                }
            </style>

            {# --- HTML Output part --- #}
            <h1>{{ 'cjw_publishtools.tracking.heading'|trans }}</h1>

            <p>{{ 'cjw_publishtools.tracking.intro'|trans }}</p>

            {#
            <p>
                Folgende Tracker werden auf <strong>{{ app.request.host }}</strong> benutzt:
            </p>

            <ul>
                {% for tracker_key, tracker_name in tracker_list %}
                    <li>{{ tracker_name }}</li>
                {% endfor %}
            </ul>
            #}

            <p>
                {{ 'cjw_publishtools.tracking.status'|trans }}
                <div id="tracker-display">
                    <div class="activated">{{ 'cjw_publishtools.tracking.status.enabled'|trans }} {% spaceless %}
                        <button class="btn btn-primary" onclick="document.Cookie.setCookie( '{{ tracking_cookie_name }}', false );document.Cookie.setCookie( 'ng-cc-analytics', 0 );window.location = window.location;">{{ 'cjw_publishtools.tracking.status.disable'|trans }}</button>
                    {% endspaceless %}</div>
                    <div class="deactivated">{{ 'cjw_publishtools.tracking.status.disabled'|trans }} {% spaceless %}
                        <button class="btn btn-primary" onclick="document.Cookie.setCookie( '{{ tracking_cookie_name }}', true );document.Cookie.setCookie( 'ng-cc-analytics', 1 );window.location = window.location;">{{ 'cjw_publishtools.tracking.status.enable'|trans }}</button>
                    {% endspaceless %}</div>
                </div>
            </p>

        </div>
    </div>

    {# --- JavaScript part --- #}
    <script>
        (function( window, document, undefined ) {
            {# Cookie functionalities – BEGIN #}
            document.Cookie = document.Cookie || {};

            {# `document.Cookie.setCookie` function #}
            if ( typeof( document.Cookie.setCookie ) !== 'function' ) {
                document.Cookie.setCookie = function ( cname, cvalue, exdays ) {
                    var d = new Date();
                    d.setTime( d.getTime() + (exdays * 24 * 60 * 60 * 1000) );
                    var expires = "expires=" + d.toUTCString();
                    document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
                };
            }

            {# `document.Cookie.getCookie` function #}
            if ( typeof( document.Cookie.getCookie ) !== 'function' ) {
                document.Cookie.getCookie = function ( cname ) {
                    var name = cname + "=";
                    var decodedCookie = decodeURIComponent( document.cookie );
                    var ca = decodedCookie.split( ';' );
                    for ( var i = 0; i < ca.length; i++ ) {
                        var c = ca[i];
                        while ( c.charAt( 0 ) == ' ' ) {
                            c = c.substring( 1 );
                        }
                        if ( c.indexOf( name ) == 0 ) {
                            return c.substring( name.length, c.length );
                        }
                    }
                    return "";
                };
            }
            {# Cookie functionalities – END #}

            {# BackwardsCompatibility Polyfill for old IE browsers – START #}
            if ( typeof EventTarget.prototype.addEventListener === 'undefined' ) {
                EventTarget.prototype.addEventListener = function ( e, callback ) {
                    e = 'on' + e;
                    return this.attachEvent( e, callback );
                };
            }
            {# BackwardsCompatibility Polyfill for old IE browsers – END #}

            {# - Functionality for displaying the current tracking status - #}
            var _trackerList = {{ tracker_list|json_encode|raw }};

            window.addEventListener( 'load', function ( ev ) {
                if ( !ev ) ev = event || window.event;

                for ( tracker in _trackerList ) {
                    if ( _trackerList.hasOwnProperty( tracker ) ) {
                        var _trackerName = _trackerList[tracker];
                        var _trackerElement = document.querySelector( "#tracker-display" );
                        var _useTracking = (document.Cookie.getCookie( "{{ tracking_cookie_name }}" ) !== "false");
                        if ( _useTracking ) {
                            _trackerElement.classList.add( "active" );
                        }
                    }
                }
            } );
        }( window, document ));
    </script>
    <!-- JAC_TRACKING_SETTINGS END -->
{% endblock %}
