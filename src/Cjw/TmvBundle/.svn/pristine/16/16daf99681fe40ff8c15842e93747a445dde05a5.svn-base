<?php

declare(strict_types=1);

namespace Cjw\TmvBundle\Block\BlockDefinition\Handler;

use eZ\Publish\API\Repository\Values\ValueObject;
use Netgen\Layouts\API\Values\Block\Block;
use Netgen\Layouts\Block\BlockDefinition\BlockDefinitionHandler;
use Netgen\Layouts\Block\DynamicParameters;
use Netgen\Layouts\Collection\QueryType\QueryTypeHandlerInterface;
use Netgen\Layouts\Parameters\ParameterBuilderInterface;
use Netgen\Layouts\Parameters\ParameterType;
use eZ\Publish\API\Repository\Repository;
use eZ\Publish\API\Repository\Values\Content\Content;
use eZ\Publish\API\Repository\Values\Content\ContentInfo;
use eZ\Publish\API\Repository\Values\Content\Query;
use eZ\Publish\API\Repository\Values\Content\Query\SortClause;
use eZ\Publish\API\Repository\Values\Content\Location;
use eZ\Publish\API\Repository\Values\Content\LocationQuery;
use eZ\Publish\API\Repository\Values\Content\Query\Criterion;
use eZ\Publish\Core\MVC\ConfigResolverInterface;
use eZ\Publish\Core\Persistence\Database\DatabaseHandler;
use Symfony\Component\HttpFoundation\RequestStack;

final class TmvEventsHandler extends BlockDefinitionHandler
{
    /**
     * @var \eZ\Publish\API\Repository\SearchService
     */
    private $searchService;

    /**
     * @var \eZ\Publish\API\Repository\Repository
     */
    protected $repository;

    /**
     * @var \eZ\Publish\API\Repository\LocationService
     */
    protected $locationService;

    /**
     * @var \eZ\Publish\Core\Persistence\Database\DatabaseHandler
     */
    protected $databaseHandler;

    /**
     * @var array
     */
    public $listAllPlaces;

    /**
     * @var array
     */
    public $listAllCategories;

    /**
     * @var \eZ\Publish\API\Repository\Values\Content\Location
     */
    public $eventContainer;

    /**
     * @var Request
     */
    public $request;

    /**
     * @var array
     */
    public $filterParams = array();

    /**
     * TmvEventsHandler constructor.
     *
     * Params are defined in services.yml!
     *
     * @param Repository $repository
     * @param DatabaseHandler $databaseHandler
     * @param RequestStack $request
     */
    public function __construct( Repository $repository, DatabaseHandler $databaseHandler, RequestStack $request )
    {
        $this->request           = $request->getCurrentRequest();
        $this->repository        = $repository;
        $this->searchService     = $this->repository->getSearchService();
        $this->locationService   = $this->repository->getLocationService();
        $this->databaseHandler   = $databaseHandler;
        $this->listAllPlaces     = $this->fetchAllPlaces();
        $this->filterParams      = $this->setFilterParams();
    }

    /**
     * Set params for netgen layouts.
     *
     * @param ParameterBuilderInterface $builder
     */
    public function buildParameters(ParameterBuilderInterface $builder): void
    {
        $builder->add('parent', ParameterType\ItemLinkType::class);
        $builder->add('limit', ParameterType\IntegerType::class);

        $builder->add(
            'view_type',
            ParameterType\ChoiceType::class,
            [
                'required' => true,
                'options' => [
                    'List' => 'list',
                    'Grid' => 'grid'
                ]
            ]
        );

        $builder->add('number_of_columns', ParameterType\IntegerType::class);
    }

    /**
     * Get params from netgen layouts, works with them and returns they to the templates.
     *
     * @param DynamicParameters $params
     * @param Block $block
     * @throws \eZ\Publish\API\Repository\Exceptions\InvalidArgumentException
     * @throws \eZ\Publish\API\Repository\Exceptions\NotFoundException
     * @throws \eZ\Publish\API\Repository\Exceptions\UnauthorizedException
     */
    public function getDynamicParameters(DynamicParameters $params, Block $block): void
    {
        $listEvents   = array();

        $parent          = $block->getParameter('parent');
        $limit           = (int) $block->getParameter('limit')->getValue();
        $numberOfColumns = (int) $block->getParameter('number_of_columns')->getValue();
        $viewType        = $block->getParameter('view_type')->getValue();

        if ( $numberOfColumns == 0 )
        {
            $numberOfColumns = 1;
        }

        if ( !$parent->isEmpty() )
        {
            // value: ezlocation://1234
            $parentLocation   = explode( '//', $parent->getValue() );
            $parentLocationId = (int) $parentLocation[ 1 ];

            $this->eventContainer = $this->locationService->loadLocation( $parentLocationId );

            // frontend fetch
            $listEvents = $this->fetchEventsByFilter( $limit, 0 );

            // backend fetch
            //$listEvents = $this->fetchEvents( $limit );

            $this->listAllCategories = $this->fetchAllCategories();
        }

        $params[ 'list_events' ]       = $listEvents;
        $params[ 'parent' ]            = $this->eventContainer;
        $params[ 'limit' ]             = $limit;
        $params[ 'number_of_columns' ] = $numberOfColumns;
        $params[ 'view_type' ]         = $viewType;
        $params[ 'list_categories' ]   = $this->listAllCategories;
        $params[ 'list_places' ]       = $this->listAllPlaces;
        $params[ 'filter_params' ]     = $this->filterParams;

    }

    public function isContextual(Block $block): bool
    {
        return false;
    }

    /**
     * Basic fetch for tmv_events. No filter logic.
     *
     * @param int $limit
     * @return array
     * @throws \eZ\Publish\API\Repository\Exceptions\InvalidArgumentException
     */
    public function fetchEvents( $limit = 100 )
    {
        $resultQuery = array();
        $listEvents  = array();

        $filter   = array();
        $filter[] = new Criterion\ParentLocationId( $this->eventContainer->id );
        $filter[] = new Criterion\ContentTypeIdentifier( 'tmv_event' );

        $query = new LocationQuery( array( 'limit' => $limit ) );
        $query->filter = new Criterion\LogicalAnd( $filter );

        $resultQuery = $this->searchService->findLocations( $query );

        foreach ( $resultQuery->searchHits as $searchItem )
        {
            $listEvents[] = $searchItem->valueObject;
        }

        return $listEvents;
    }

    /**
     * Fetches dates and their parent events. Use filters by user input.
     *
     * @param int $limit
     * @param int $offset
     * @return array
     * @throws \eZ\Publish\API\Repository\Exceptions\InvalidArgumentException
     */
    public function fetchEventsByFilter( $limit = 100, $offset = 0 )
    {
        $listEvents = array( 'sorted_event_location_ids' => array(), 'list' => array() );

        if ( $this->eventContainer instanceof Location )
        {
            //
            // fetch event dates
            //

            $filterEventDates = array();
            $filterEventDates[] = new Criterion\Subtree( $this->eventContainer->pathString );
            $filterEventDates[] = new Criterion\ContentTypeIdentifier('tmv_date');

            if ( $this->filterParams[ 'start' ] != '' && $this->filterParams[ 'end' ] != '' )
            {
                $dateFilter   = array();
                $dateFilter[] = new Criterion\Field( 'start', Criterion\Operator::GTE, strtotime( $this->filterParams[ 'start' ] ) );
                $dateFilter[] = new Criterion\Field( 'end', Criterion\Operator::LTE, strtotime( $this->filterParams[ 'end' ] ) );

                $filterEventDates[] = new Criterion\LogicalAnd( $dateFilter );
            }
            elseif ( $this->filterParams[ 'start' ] != '' )
            {
                $filterEventDates[] = new Criterion\Field( 'start', Criterion\Operator::GTE, strtotime( $this->filterParams[ 'start' ] ) );
            }
            elseif ( $this->filterParams[ 'end' ] != '' )
            {
                $filterEventDates[] = new Criterion\Field( 'end', Criterion\Operator::LTE, strtotime( $this->filterParams[ 'end' ] ) );
            }

            //$queryEventDates              = new LocationQuery( array( 'offset' => $offset, 'limit' => $limit ) );
            $queryEventDates              = new LocationQuery();
            $queryEventDates->sortClauses = [ new SortClause\Field('tmv_date', 'start', QUERY::SORT_ASC) ];
            $queryEventDates->filter      = new Criterion\LogicalAnd( $filterEventDates );

            $resultQueryEventDates = $this->searchService->findLocations( $queryEventDates );

            if ( $resultQueryEventDates->totalCount != 0 )
            {
                foreach ( $resultQueryEventDates->searchHits as $index => $searchItem )
                {
                    $eventDateLocation         = $searchItem->valueObject;
                    $eventDateParentLocationId = (int) $eventDateLocation->parentLocationId;

                    if ( isset( $listEvents[ 'grouped_dates_by_event' ][ $eventDateParentLocationId ] ) === FALSE )
                    {
                        $listEvents[ 'grouped_dates_by_event' ][ $eventDateParentLocationId ] = array();
                    }

                    $listEvents[ 'grouped_dates_by_event' ][ $eventDateParentLocationId ][] = $eventDateLocation;

                    if ( in_array( $eventDateParentLocationId, $listEvents[ 'sorted_event_location_ids' ] ) === FALSE )
                    {
                        $listEvents[ 'sorted_event_location_ids' ][]                                   = $eventDateParentLocationId;
                        $listEvents[ 'sorted_event_location_ids_index' ][ $eventDateParentLocationId ] = $index;
                    }
                }

                //
                // fetch events
                //

                $filterEventIds = array_slice( $listEvents[ 'sorted_event_location_ids' ], $offset, $limit );

                if ( count( $filterEventIds ) > 0 )
                {
                    $filterEvents   = array();
                    $filterEvents[] = new Criterion\ContentTypeIdentifier('tmv_event' );
                    $filterEvents[] = new Criterion\LocationId( $filterEventIds );

                    if ( count( $this->filterParams[ 'places' ] ) != 0 )
                    {
                        $filterEvents[] = new Criterion\Field('place', Criterion\Operator::IN, $this->filterParams[ 'places' ] );
                    }

                    if ( count( $this->filterParams[ 'categories' ] ) != 0 )
                    {
                        $categoryFilter = array();

                        foreach ( $this->filterParams[ 'categories' ] as $category )
                        {
                            $categoryFilter[] = new Criterion\Field( 'categories', Criterion\Operator::LIKE, $category );
                            $categoryFilter[] = new Criterion\Field( 'categories', Criterion\Operator::LIKE, '*-' .$category );
                            $categoryFilter[] = new Criterion\Field( 'categories', Criterion\Operator::LIKE, $category . '-*' );
                        }

                        $filterEvents[] = new Criterion\LogicalOr( $categoryFilter );
                    }

                    if ( $this->filterParams[ 'keyword' ] != '' )
                    {
                        $filterEvents[] = new Criterion\FullText( $this->filterParams[ 'keyword' ] );
                    }

                    //$queryEvents = new LocationQuery();
                    $queryEvents         = new LocationQuery( array( 'offset' => $offset, 'limit' => $limit ) );
                    $queryEvents->filter = new Criterion\LogicalAnd( $filterEvents );

                    $resultQueryEvents = $this->searchService->findLocations( $queryEvents );

                    if ( $resultQueryEvents->totalCount != 0 )
                    {
                        $resultArray = array();
                        foreach ( $resultQueryEvents->searchHits as $index => $searchItem )
                        {
                            // sorting
                            $newIndex = $index;
                            if ( isset( $listEvents[ 'sorted_event_location_ids_index' ][ $searchItem->valueObject->id ] ) )
                            {
                                $newIndex = (int) $listEvents[ 'sorted_event_location_ids_index' ][ $searchItem->valueObject->id ];
                            }

                            $resultArray[ $newIndex ] = $searchItem->valueObject;
                        }

                        ksort( $resultArray );

                        $listEvents[ 'list' ] = $resultArray;
                    }
                }
            }
        }

        return $listEvents;
    }

    /**
     * Fetch all existing categorie content objects.
     *
     * @return array
     * @throws \eZ\Publish\API\Repository\Exceptions\InvalidArgumentException
     */
    public function fetchAllCategories()
    {
        $list = array();

        if ( $this->eventContainer instanceof Location )
        {
            $filter = array();
            $filter[] = new Criterion\Subtree( $this->eventContainer->pathString );
            $filter[] = new Criterion\ContentTypeIdentifier('tmv_categorie' );

            $query = new LocationQuery();
            $query->filter = new Criterion\LogicalAnd( $filter );

            $result = $this->searchService->findLocations( $query );

            foreach ( $result->searchHits as $searchItem )
            {
                $category        = $searchItem->valueObject;
                $categoryContent = $category->getContent();
                $categoryId      = (int) $categoryContent->getFieldValue( 'id' )->__toString();
                $categoryTitle   = $categoryContent->getFieldValue( 'title' )->__toString();

                $list[ $categoryId ] = $categoryTitle;
            }

            asort( $list, SORT_STRING | SORT_FLAG_CASE );
        }

        return $list;
    }

    /**
     * Fetch existing places by place attribute of tmv_event.
     *
     * @return array
     */
    public function fetchAllPlaces()
    {
        $query = $this->databaseHandler->createSelectQuery();
        $query->selectDistinct( 'ezcontentobject_attribute.data_text' )
            ->from( $this->databaseHandler->quoteTable( 'ezcontentobject_attribute' ) )
            ->from( $this->databaseHandler->quoteTable( 'ezcontentclass' ) )
            ->from( $this->databaseHandler->quoteTable( 'ezcontentclass_attribute' ) )
            ->where(
                $query->expr->lAnd(
                    $query->expr->eq( $this->databaseHandler->quoteColumn( 'identifier', 'ezcontentclass' ), $query->bindValue( 'tmv_event', null, \PDO::PARAM_STR ) ),
                    $query->expr->eq( $this->databaseHandler->quoteColumn( 'contentclassattribute_id', 'ezcontentobject_attribute' ), $this->databaseHandler->quoteColumn( 'id', 'ezcontentclass_attribute' ) ),
                    $query->expr->lAnd(
                        $query->expr->eq( $this->databaseHandler->quoteColumn( 'id', 'ezcontentclass' ), $this->databaseHandler->quoteColumn( 'contentclass_id', 'ezcontentclass_attribute' ) ),
                        $query->expr->eq( $this->databaseHandler->quoteColumn( 'identifier', 'ezcontentclass_attribute' ), $query->bindValue( 'place', null, \PDO::PARAM_STR ) )
                    )
                )
            )
            ->groupBy( $this->databaseHandler->quoteColumn( 'data_text', 'ezcontentobject_attribute' ) )
            ->orderBy( $this->databaseHandler->quoteColumn( 'data_text', 'ezcontentobject_attribute' ) )
        ;

        $result = $query->prepare();
        $result->execute();

        $result = $result->fetchAll();

        $list = array();

        if ( isset( $result[ 0 ] ) )
        {
            foreach ( $result as $item )
            {
                $list[] = $item[ 'data_text' ];
            }
        }

        return $list;
    }

    /**
     * Get user filter params and save it in global array.
     *
     * @return array
     */
    public function setFilterParams()
    {
        $keyword = '';
        if ( $this->request->get( 'Keyword' ) != '' )
        {
            $keyword = strip_tags( trim( $this->request->get( 'Keyword' ) ) );
        }

        $start = '';
        if ( $this->request->get( 'Start' ) != '' )
        {
            $start = strip_tags( trim( $this->request->get( 'Start' ) ) );
        }

        $end = '';
        if ( $this->request->get( 'End' ) != '' )
        {
            $end = strip_tags( trim( $this->request->get( 'End' ) ) );
        }

        $categories = array();
        if ( $this->request->get( 'Categories' ) != '' )
        {
            $categories = (array) $this->request->get( 'Categories' );
        }

        $places = array();
        if ( $this->request->get( 'Places' ) != '' )
        {
            $places = (array) $this->request->get( 'Places' );
        }

        return array( 'keyword' => $keyword, 'start' => $start, 'end' => $end, 'categories' => $categories, 'places' => $places );
    }
}
